<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/examples/invoker-tests.md.vm at 2023-11-02
 | Rendered using Apache Maven Fluido Skin 1.11.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <meta name="author" content="Stephen Connolly" />
    <meta name="date" content="2013-02-23" />
    <title>Mock Repository Manager Maven Plugin &#x2013; Using with Maven Invoker</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.11.1.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.11.1.min.js"></script>

    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
                _paq.push(['disableCookies']);
                    _paq.push(['trackPageView']);
                    _paq.push(['enableLinkTracking']);
        
        (function() {
            var u="https://analytics.apache.org/";
            _paq.push(['setTrackerUrl', u+'/matomo.php']);
            _paq.push(['setSiteId', '18']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    <!-- End Matomo Code -->
    <style>.github-fork-ribbon:before { background-color: gray; }</style>
  </head>
  <body class="topBarDisabled">
    <a class="github-fork-ribbon right-top" href="https://github.com/mojohaus/mrm" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="../../../" id="bannerLeft"><img src="../../../images/mojo_logo.png"  alt="MojoHaus" style="" /></a></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
      <li class=""><a href="../../../" title="MojoHaus">MojoHaus</a><span class="divider">/</span></li>
      <li class=""><a href="../.." title="Mock Repository Manager :: Project">Mock Repository Manager :: Project</a><span class="divider">/</span></li>
      <li class=""><a href="../index.html" title="Mock Repository Manager Maven Plugin">Mock Repository Manager Maven Plugin</a><span class="divider">/</span></li>
    <li class="active ">Using with Maven Invoker <a href="https://github.com/mojohaus/mrm/tree/master/mrm-maven-plugin/src/site/markdown/examples/invoker-tests.md.vm"><img src="../images/accessories-text-editor.png" title="Edit" /></a></li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2023-11-02</li>
          <li id="projectVersion" class="pull-right"><span class="divider">|</span>Version: 1.6.0</li>
        <li class="pull-right"><a href="https://maven.apache.org/" class="externalLink" title="Maven">Maven</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="Mock Repository Manager :: Project"><span class="none"></span>Mock Repository Manager :: Project</a></li>
   <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../plugin-info.html" title="Goals"><span class="none"></span>Goals</a></li>
    <li><a href="../usage.html" title="Usage"><span class="none"></span>Usage</a></li>
   <li class="nav-header">Examples</li>
    <li class="active"><a><span class="none"></span>Using with Maven Invoker (download)</a></li>
    <li><a href="../examples/invoker-tests-dist.html" title="Using with Maven Invoker (upload)"><span class="none"></span>Using with Maven Invoker (upload)</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<!---
Copyright 2011 Stephen Connolly

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<h1>Using with Maven Invoker and Repositories</h1>
<p>The aim here is to combine the usage of the <code>mrm-maven-plugin</code> with the <code>maven-invoker-plugin</code> to
allow the integration tests of a Maven Plugin to be run against a test local repository thereby ensuring that
the plugin does not get installed into the local repository until after the integration tests have been confirmed
as passing.</p>
<p>First we need to modify the <code>pom.xml</code> to reference both <code>mrm-maven-plugin</code> and the
<code>maven-invoker-plugin</code></p>

<div class="source"><pre class="prettyprint"><code class="language-xml">&lt;project&gt;
  ...
  &lt;build&gt;
    ...
    &lt;plugins&gt;
      ...
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-invoker-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.0.0&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;install&lt;/goal&gt;
              &lt;goal&gt;integration-test&lt;/goal&gt;
              &lt;goal&gt;verify&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
        &lt;configuration&gt;
          &lt;localRepositoryPath&gt;${project.build.directory}/local-repo&lt;/localRepositoryPath&gt;
          &lt;projectsDirectory&gt;src/it/projects&lt;/projectsDirectory&gt;
          &lt;settingsFile&gt;src/it/mrm/settings.xml&lt;/settingsFile&gt;
          &lt;filterProperties&gt;
            &lt;mrm.repository.url&gt;${mrm.repository.url}&lt;/mrm.repository.url&gt;
          &lt;/filterProperties&gt;
          ...
        &lt;/configuration&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;mrm-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.6.0&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;start&lt;/goal&gt;
              &lt;goal&gt;stop&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
        &lt;configuration&gt;
          &lt;repositories&gt;

            &lt;!-- serve content from mock repository --&gt;
            &lt;mockRepo&gt;
              &lt;source&gt;src/it/mrm/repository&lt;/source&gt;
              &lt;!-- cloneTo&gt;target/mock-repo&lt;/cloneTo --&gt;
              &lt;!-- cloneClean&gt;true&lt;/cloneClean --&gt;
              &lt;!-- lazyArchiver&gt;false&lt;/lazyArchiver --&gt;
            &lt;/mockRepo&gt;

            &lt;!-- serve content installed by maven-invoker-plugin --&gt;
            &lt;localRepo&gt;
              &lt;source&gt;${project.build.directory}/local-repo&lt;/source&gt;
            &lt;/localRepo&gt;

            &lt;!-- pass everything else to current Maven instance --&gt;
            &lt;proxyRepo/&gt;
          &lt;/repositories&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
      ...
    &lt;/plugins&gt;
    ...
  &lt;/build&gt;
  ...
&lt;/project&gt;
</code></pre></div>
<p>This will result in the following mojos being executed during the lifecycle as follows:</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th><i>Phase</i></th>
<th><i>Goal(s)</i></th></tr>
</thead><tbody>

<tr class="b">
<td align="left">pre-integration-test</td>
<td>mrm:start, invoker:install</td></tr>
<tr class="a">
<td align="left">integration-test</td>
<td>invoker:integration-test</td></tr>
<tr class="b">
<td align="left">post-integration-test</td>
<td>mrm:stop</td></tr>
<tr class="a">
<td align="left">verify</td>
<td>invoker:verify</td></tr>
</tbody>
</table>
<p>Additionally, when <code>mrm:start</code> is invoked, it will bind to an available port and set the property
<code>repository.proxy.url</code> to the URL on which the repository is being hosted, and the repository content
will be based on the <code>mockRepo</code> content generated from the following files in <code>src/it/mrm/repository</code>:</p>
<ul>

<li><code>**/*.pom</code></li>
<li><code>**/*-\{classifier\}.{type}</code> as file, which will use the GAV of the corresponding <code>pom</code> -file (e.g. <code>mojo-parent-10.pom</code> with <code>mojo-parent-10-site.xml</code> )</li>
<li><code>**/*.jar</code> as directory, which will use the GAV of the corresponding <code>pom</code> -file. MRM will create an archive of this directory.</li>
<li><code>**/*-\{classifier\}.jar</code> as directory, which will use the GAV of the corresponding <code>pom</code> -file. MRM will create an archive of this directory.</li>
<li><code>archetype-catalog.xml</code></li>
</ul>
<p>In additional content install by <code>maven-invoker-plugin:install</code> will be available by <i>localRepo</i></p>
<p>Finally thanks to <code>proxyRepo</code>, all the repositories available to the current Maven instance will be available too.</p>
<p>We tell <code>maven-invoker-plugin</code> to use the <code>settings.xml</code> file from <code>src/it/mrm/settings.xml</code>
which will look something like:</p>

<div class="source"><pre class="prettyprint"><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;settings&gt;
  &lt;mirrors&gt;
    &lt;mirror&gt;
      &lt;id&gt;mrm-maven-plugin&lt;/id&gt;
      &lt;name&gt;Mock Repository Manager&lt;/name&gt;
      &lt;url&gt;@mrm.repository.url@&lt;/url&gt;
      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
    &lt;/mirror&gt;
  &lt;/mirrors&gt;
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;it-repo&lt;/id&gt;
      &lt;repositories&gt;
        &lt;repository&gt;
          &lt;id&gt;snapshots&lt;/id&gt;
          &lt;url&gt;@mrm.repository.url@&lt;/url&gt;
          &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;checksumPolicy&gt;ignore&lt;/checksumPolicy&gt;
            &lt;updatePolicy&gt;never&lt;/updatePolicy&gt;
          &lt;/releases&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;checksumPolicy&gt;ignore&lt;/checksumPolicy&gt;
            &lt;updatePolicy&gt;always&lt;/updatePolicy&gt;
          &lt;/snapshots&gt;
        &lt;/repository&gt;
      &lt;/repositories&gt;
      &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
          &lt;id&gt;snapshots&lt;/id&gt;
          &lt;url&gt;@mrm.repository.url@&lt;/url&gt;
          &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;checksumPolicy&gt;ignore&lt;/checksumPolicy&gt;
            &lt;updatePolicy&gt;never&lt;/updatePolicy&gt;
          &lt;/releases&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;checksumPolicy&gt;ignore&lt;/checksumPolicy&gt;
            &lt;updatePolicy&gt;always&lt;/updatePolicy&gt;
          &lt;/snapshots&gt;
        &lt;/pluginRepository&gt;
      &lt;/pluginRepositories&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
  &lt;activeProfiles&gt;
    &lt;activeProfile&gt;it-repo&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;
  
&lt;/settings&gt;
</code></pre></div>
<p>And we also have instructed the <code>maven-invoker-plugin</code> to filter in the property value <code>repository.proxy.url</code>
Thus when the integration tests run, they will use the mock repository manager that we have provisioned.</p>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2009&#x2013;2023
<a href="https://www.mojohaus.org">MojoHaus</a>
</p>
        </div>
      </div>
    </footer>
<script>
	if(anchors) {
	  anchors.add();
	}
</script>
  </body>
</html>